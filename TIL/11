const fs = require('fs');
const path = require('path');
const readline = require('readline');

const DATA_FILE = path.join(__dirname, 'todos.json');

// ==================== Todo Model ==================== //
class Todo {
  constructor(id, title, dueDate = null, completed = false, createdAt = new Date()) {
    this.id = id;
    this.title = title;
    this.dueDate = dueDate;
    this.completed = completed;
    this.createdAt = createdAt;
    this.updatedAt = new Date();
  }
}

// ==================== Storage ==================== //
class TodoStorage {
  static load() {
    if (!fs.existsSync(DATA_FILE)) return [];
    const data = fs.readFileSync(DATA_FILE, 'utf-8');
    try {
      const parsed = JSON.parse(data);
      return parsed.map(
        t => new Todo(t.id, t.title, t.dueDate, t.completed, new Date(t.createdAt))
      );
    } catch (e) {
      console.error('âš  ì €ì¥ì†Œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', e.message);
      return [];
    }
  }

  static save(todos) {
    fs.writeFileSync(DATA_FILE, JSON.stringify(todos, null, 2), 'utf-8');
  }
}

// ==================== Todo Manager ==================== //
class TodoManager {
  constructor() {
    this.todos = TodoStorage.load();
  }

  generateId() {
    return `${Date.now()}-${Math.floor(Math.random() * 10000)}`;
  }

  create(title, dueDate = null) {
    const id = this.generateId();
    const todo = new Todo(id, title, dueDate);
    this.todos.push(todo);
    this.persist();
    return todo;
  }

  findById(id) {
    return this.todos.find(todo => todo.id === id);
  }

  update(id, newTitle, newDueDate = null) {
    const todo = this.findById(id);
    if (todo) {
      todo.title = newTitle;
      todo.dueDate = newDueDate;
      todo.updatedAt = new Date();
      this.persist();
    }
  }

  delete(id) {
    this.todos = this.todos.filter(todo => todo.id !== id);
    this.persist();
  }

  toggle(id) {
    const todo = this.findById(id);
    if (todo) {
      todo.completed = !todo.completed;
      todo.updatedAt = new Date();
      this.persist();
    }
  }

  clearCompleted() {
    this.todos = this.todos.filter(todo => !todo.completed);
    this.persist();
  }

  sortByDate(order = 'asc') {
    return [...this.todos].sort((a, b) => {
      return order === 'asc'
        ? new Date(a.createdAt) - new Date(b.createdAt)
        : new Date(b.createdAt) - new Date(a.createdAt);
    });
  }

  filter(filterType = 'all') {
    switch (filterType) {
      case 'completed':
        return this.todos.filter(t => t.completed);
      case 'active':
        return this.todos.filter(t => !t.completed);
      default:
        return this.todos;
    }
  }

  persist() {
    TodoStorage.save(this.todos);
  }

  reset() {
    this.todos = [];
    this.persist();
  }
}

// ==================== Utility ==================== //
function formatDate(date) {
  if (!date) return 'ì—†ìŒ';
  return new Date(date).toISOString().slice(0, 10);
}

function displayTodos(todos) {
  if (!todos.length) {
    console.log('\nâš  í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.\n');
    return;
  }
  console.log('\nğŸ“‹ í˜„ì¬ í•  ì¼ ëª©ë¡');
  todos.forEach((todo, index) => {
    console.log(
      `${index + 1}. [${todo.completed ? 'âœ”' : ' '}] ${todo.title} (ë§ˆê°: ${formatDate(
        todo.dueDate
      )}) [ID: ${todo.id}]`
    );
  });
  console.log('');
}

// ==================== CLI ==================== //
class TodoCLI {
  constructor() {
    this.manager = new TodoManager();
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
    });
  }

  start() {
    console.log('\nğŸ§  ToDo CLIì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n');
    this.showHelp();
    this.rl.setPrompt('ğŸ“Œ ëª…ë ¹ ì…ë ¥ > ');
    this.rl.prompt();
    this.rl.on('line', line => {
      const [command, ...args] = line.trim().split(' ');
      this.handleCommand(command.toLowerCase(), args);
      this.rl.prompt();
    });
  }

  handleCommand(command, args) {
    switch (command) {
      case 'add':
        this.addFlow(args);
        break;
      case 'list':
        displayTodos(this.manager.todos);
        break;
      case 'done':
        this.toggleFlow(args);
        break;
      case 'delete':
        this.deleteFlow(args);
        break;
      case 'update':
        this.updateFlow(args);
        break;
      case 'clear':
        this.manager.clearCompleted();
        console.log('âœ… ì™„ë£Œëœ í•­ëª© ëª¨ë‘ ì‚­ì œë¨.');
        break;
      case 'sort':
        const order = args[0] === 'desc' ? 'desc' : 'asc';
        displayTodos(this.manager.sortByDate(order));
        break;
      case 'filter':
        displayTodos(this.manager.filter(args[0]));
        break;
      case 'reset':
        this.manager.reset();
        console.log('ğŸ—‘ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”ë¨.');
        break;
      case 'help':
        this.showHelp();
        break;
      case 'exit':
        this.rl.close();
        break;
      default:
        console.log('âš  ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. `help`ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    }
  }

  addFlow(args) {
    const title = args.join(' ');
    if (!title) {
      console.log('â— ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: add ê³µë¶€í•˜ê¸°');
      return;
    }
    this.manager.create(title);
    console.log(`âœ… "${title}" ì¶”ê°€ë¨.`);
  }

  toggleFlow(args) {
    const id = args[0];
    if (!id) return console.log('â— IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: done 123456');
    this.manager.toggle(id);
    console.log(`âœ… ID ${id} ì™„ë£Œ ìƒíƒœ í† ê¸€ë¨.`);
  }

  deleteFlow(args) {
    const id = args[0];
    if (!id) return console.log('â— IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: delete 123456');
    this.manager.delete(id);
    console.log(`ğŸ—‘ ID ${id} ì‚­ì œë¨.`);
  }

  updateFlow(args) {
    const id = args[0];
    const newTitle = args.slice(1).join(' ');
    if (!id || !newTitle) {
      console.log('â— ì‚¬ìš©ë²•: update <id> <ìƒˆ ì œëª©>');
      return;
    }
    this.manager.update(id, newTitle);
    console.log(`âœ ID ${id} ë‚´ìš©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }

  showHelp() {
    console.log(`
ğŸ“ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:
 add <ë‚´ìš©>          : ìƒˆ í•  ì¼ ì¶”ê°€
 list                : ì „ì²´ í•  ì¼ ëª©ë¡ ì¶œë ¥
 done <id>           : í•  ì¼ ì™„ë£Œ ìƒíƒœ í† ê¸€
 update <id> <ë‚´ìš©>  : í•  ì¼ ë‚´ìš© ìˆ˜ì •
 delete <id>         : í•  ì¼ ì‚­ì œ
 clear               : ì™„ë£Œëœ í•­ëª© ëª¨ë‘ ì‚­ì œ
 sort asc|desc       : ìƒì„±ì¼ ê¸°ì¤€ ì •ë ¬
 filter all|active|completed : í•„í„°ë§
 reset               : ì „ì²´ ì´ˆê¸°í™”
 help                : ëª…ë ¹ì–´ ë„ì›€ë§
 exit                : ì¢…ë£Œ
`);
  }
}

// ==================== Run CLI ==================== //
if (require.main === module) {
  const cli = new TodoCLI();
  cli.start();
}
